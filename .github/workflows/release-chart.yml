name: Release Helm Chart

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0, v1.2.3, etc.

env:
  REGISTRY: ghcr.io
  CHART_NAME: patchmon

jobs:
  release:
    runs-on: self-hosted
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          # Remove 'v' prefix from tag (v1.2.3 -> 1.2.3)
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag version: $VERSION"

      - name: Verify Chart.yaml version matches tag
        run: |
          CHART_VERSION=$(grep '^version:' Chart.yaml | awk '{print $2}' | tr -d '"')
          TAG_VERSION="${{ steps.version.outputs.version }}"
          
          echo "Chart.yaml version: $CHART_VERSION"
          echo "Git tag version: $TAG_VERSION"
          
          if [ "$CHART_VERSION" != "$TAG_VERSION" ]; then
            echo "ERROR: Chart version ($CHART_VERSION) does not match git tag ($TAG_VERSION)"
            exit 1
          fi
          
          echo "Chart version verification passed"

      - name: Verify appVersion matches image tags
        run: |
          APP_VERSION=$(grep '^appVersion:' Chart.yaml | awk '{print $2}' | tr -d '"v')
          BACKEND_TAG=$(grep -A 5 '^backend:' values.yaml | grep 'tag:' | awk '{print $2}' | tr -d '"')
          FRONTEND_TAG=$(grep -A 5 '^frontend:' values.yaml | grep 'tag:' | awk '{print $2}' | tr -d '"')
          
          echo "Chart.yaml appVersion: $APP_VERSION"
          echo "Backend image tag: $BACKEND_TAG"
          echo "Frontend image tag: $FRONTEND_TAG"
          
          if [ "$APP_VERSION" != "$BACKEND_TAG" ]; then
            echo "ERROR: appVersion ($APP_VERSION) does not match backend tag ($BACKEND_TAG)"
            exit 1
          fi
          
          if [ "$APP_VERSION" != "$FRONTEND_TAG" ]; then
            echo "ERROR: appVersion ($APP_VERSION) does not match frontend tag ($FRONTEND_TAG)"
            exit 1
          fi
          
          echo "appVersion verification passed"

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: '3.14.0'

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ${{ env.REGISTRY }} \
            --username ${{ github.actor }} \
            --password-stdin

      - name: Package Helm chart
        run: |
          helm package . --destination .helm-package
          echo "Chart packaged successfully"

      - name: Push chart to OCI registry
        run: |
          CHART_PACKAGE=$(ls .helm-package/${{ env.CHART_NAME }}-*.tgz)
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          helm push "$CHART_PACKAGE" oci://${{ env.REGISTRY }}/${REPO_OWNER_LOWER}/charts
          echo "Chart pushed to OCI registry"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: .helm-package/${{ env.CHART_NAME }}-*.tgz
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output installation instructions
        run: |
          REPO_OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "ðŸŽ‰ Chart released successfully!"
          echo ""
          echo "Install with:"
          echo "  helm install patchmon oci://${{ env.REGISTRY }}/${REPO_OWNER_LOWER}/charts/${{ env.CHART_NAME }} --version ${{ steps.version.outputs.version }}"
          echo ""
          echo "Or upgrade with:"
          echo "  helm upgrade patchmon oci://${{ env.REGISTRY }}/${REPO_OWNER_LOWER}/charts/${{ env.CHART_NAME }} --version ${{ steps.version.outputs.version }}"
